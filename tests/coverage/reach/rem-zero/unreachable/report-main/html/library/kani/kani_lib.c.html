
<html>
<head>
<title>library/kani/kani_lib.c</title>
<link rel="stylesheet" type="text/css" href="../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 // Copyright Kani Contributors</div><div id="2" class="line none">    2 // SPDX-License-Identifier: Apache-2.0 OR MIT</div><div id="3" class="line none">    3 #include &lt;stddef.h&gt;</div><div id="4" class="line none">    4 #include &lt;stdint.h&gt;</div><div id="5" class="line none">    5 </div><div id="6" class="line none">    6 // Declare functions instead of importing more headers in order to avoid conflicting definitions.</div><div id="7" class="line none">    7 // See https://github.com/model-checking/kani/issues/1774 for more details.</div><div id="8" class="line none">    8 void  <a href="kani_lib.c.html#8">free</a>(void *ptr);</div><div id="9" class="line none">    9 void *<a href="kani_lib.c.html#9">memcpy</a>(void *dst, const void *src, size_t n);</div><div id="10" class="line none">   10 void *<a href="kani_lib.c.html#10">calloc</a>(size_t nmemb, size_t size);</div><div id="11" class="line none">   11 </div><div id="12" class="line none">   12 typedef <a href="kani_lib.c.html#12">__CPROVER_bool</a> <a href="kani_lib.c.html#12">bool</a>;</div><div id="13" class="line none">   13 </div><div id="14" class="line none">   14 /// Mapping unit to `void` works for functions with no return type but not for</div><div id="15" class="line none">   15 /// variables with type unit. We treat both uniformly by declaring an empty</div><div id="16" class="line none">   16 /// struct type: `struct Unit {}` and a global variable `struct Unit VoidUnit`</div><div id="17" class="line none">   17 /// returned by all void functions (both declared by the Kani compiler).</div><div id="18" class="line none">   18 struct Unit;</div><div id="19" class="line none">   19 extern struct Unit VoidUnit;</div><div id="20" class="line none">   20 </div><div id="21" class="line none">   21 // `assert` then `assume`</div><div id="22" class="line none">   22 #define <a href="kani_lib.c.html#22">__KANI_assert</a>(cond, msg)            \</div><div id="23" class="line none">   23     do {                                    \</div><div id="24" class="line none">   24         <a href="kani_lib.c.html#12">bool</a> __KANI_temp = (cond);          \</div><div id="25" class="line none">   25         __CPROVER_assert(__KANI_temp, msg); \</div><div id="26" class="line none">   26         __CPROVER_assume(__KANI_temp);      \</div><div id="27" class="line none">   27     } while (0)</div><div id="28" class="line none">   28 </div><div id="29" class="line none">   29 // Check that the input is either a power of 2, or 0. Algorithm from Hackers Delight.</div><div id="30" class="line none">   30 <a href="kani_lib.c.html#12">bool</a> <a href="kani_lib.c.html#30">__KANI_is_nonzero_power_of_two</a>(size_t i) { return (i != 0) &amp;&amp; (i &amp; (i - 1)) == 0; }</div><div id="31" class="line none">   31 </div><div id="32" class="line none">   32 // This is a C implementation of the __rust_alloc function.</div><div id="33" class="line none">   33 // https://stdrs.dev/nightly/x86_64-unknown-linux-gnu/alloc/alloc/fn.__rust_alloc.html</div><div id="34" class="line none">   34 // It has the following Rust signature:</div><div id="35" class="line none">   35 //   `unsafe fn __rust_alloc(size: usize, align: usize) -&gt; *mut u8`</div><div id="36" class="line none">   36 // This low-level function is called by std::alloc:alloc, and its</div><div id="37" class="line none">   37 // implementation is provided by the compiler backend, so we need to provide an</div><div id="38" class="line none">   38 // implementation for it to prevent verification failure due to missing function</div><div id="39" class="line none">   39 // definition.</div><div id="40" class="line none">   40 // For safety, refer to the documentation of GlobalAlloc::alloc:</div><div id="41" class="line none">   41 // https://doc.rust-lang.org/std/alloc/trait.GlobalAlloc.html#tymethod.alloc</div><div id="42" class="line none">   42 uint8_t *<a href="kani_lib.c.html#42">__rust_alloc</a>(size_t size, size_t align)</div><div id="43" class="line none">   43 {</div><div id="44" class="line none">   44     <a href="kani_lib.c.html#22">__KANI_assert</a>(size &gt; 0, "__rust_alloc must be called with a size greater than 0");</div><div id="45" class="line none">   45     // TODO: Ensure we are doing the right thing with align</div><div id="46" class="line none">   46     // https://github.com/model-checking/kani/issues/1168</div><div id="47" class="line none">   47     <a href="kani_lib.c.html#22">__KANI_assert</a>(<a href="kani_lib.c.html#30">__KANI_is_nonzero_power_of_two</a>(align), "Alignment is power of two");</div><div id="48" class="line none">   48     return malloc(size);</div><div id="49" class="line none">   49 }</div><div id="50" class="line none">   50 </div><div id="51" class="line none">   51 // This is a C implementation of the __rust_alloc_zeroed function.</div><div id="52" class="line none">   52 // https://stdrs.dev/nightly/x86_64-unknown-linux-gnu/alloc/alloc/fn.__rust_alloc_zeroed.html</div><div id="53" class="line none">   53 // It has the following Rust signature:</div><div id="54" class="line none">   54 //   unsafe fn __rust_alloc_zeroed(size: usize, align: usize) -&gt; *mut u8</div><div id="55" class="line none">   55 // This low-level function is called by std::alloc:alloc_zeroed, and its</div><div id="56" class="line none">   56 // implementation is provided by the compiler backend, so we need to provide an</div><div id="57" class="line none">   57 // implementation for it to prevent verification failure due to missing function</div><div id="58" class="line none">   58 // definition.</div><div id="59" class="line none">   59 // For safety, refer to the documentation of GlobalAlloc::alloc_zeroed:</div><div id="60" class="line none">   60 // hhttps://doc.rust-lang.org/std/alloc/fn.alloc_zeroed.html</div><div id="61" class="line none">   61 uint8_t *<a href="kani_lib.c.html#61">__rust_alloc_zeroed</a>(size_t size, size_t align)</div><div id="62" class="line none">   62 {</div><div id="63" class="line none">   63     <a href="kani_lib.c.html#22">__KANI_assert</a>(size &gt; 0, "__rust_alloc_zeroed must be called with a size greater than 0");</div><div id="64" class="line none">   64     // TODO: Ensure we are doing the right thing with align</div><div id="65" class="line none">   65     // https://github.com/model-checking/kani/issues/1168</div><div id="66" class="line none">   66     <a href="kani_lib.c.html#22">__KANI_assert</a>(<a href="kani_lib.c.html#30">__KANI_is_nonzero_power_of_two</a>(align), "Alignment is power of two");</div><div id="67" class="line none">   67     return <a href="kani_lib.c.html#10">calloc</a>(1, size);</div><div id="68" class="line none">   68 }</div><div id="69" class="line none">   69 </div><div id="70" class="line none">   70 // This is a C implementation of the __rust_dealloc function.</div><div id="71" class="line none">   71 // https://stdrs.dev/nightly/x86_64-unknown-linux-gnu/alloc/alloc/fn.__rust_dealloc.html</div><div id="72" class="line none">   72 // It has the following Rust signature:</div><div id="73" class="line none">   73 //   `unsafe fn __rust_dealloc(ptr: *mut u8, size: usize, align: usize)`</div><div id="74" class="line none">   74 // This low-level function is called by std::alloc:dealloc, and its</div><div id="75" class="line none">   75 // implementation is provided by the compiler backend, so we need to provide an</div><div id="76" class="line none">   76 // implementation for it to prevent verification failure due to missing function</div><div id="77" class="line none">   77 // definition.</div><div id="78" class="line none">   78 // For safety, refer to the documentation of GlobalAlloc::dealloc:</div><div id="79" class="line none">   79 // https://doc.rust-lang.org/std/alloc/trait.GlobalAlloc.html#tymethod.dealloc</div><div id="80" class="line none">   80 struct Unit <a href="kani_lib.c.html#80">__rust_dealloc</a>(uint8_t *ptr, size_t size, size_t align)</div><div id="81" class="line none">   81 {</div><div id="82" class="line none">   82     // TODO: Ensure we are doing the right thing with align</div><div id="83" class="line none">   83     // https://github.com/model-checking/kani/issues/1168</div><div id="84" class="line none">   84     <a href="kani_lib.c.html#22">__KANI_assert</a>(<a href="kani_lib.c.html#30">__KANI_is_nonzero_power_of_two</a>(align), "Alignment is power of two");</div><div id="85" class="line none">   85 </div><div id="86" class="line none">   86     <a href="kani_lib.c.html#22">__KANI_assert</a>(__CPROVER_OBJECT_SIZE(ptr) == size,</div><div id="87" class="line none">   87                   "rust_dealloc must be called on an object whose allocated size matches its layout");</div><div id="88" class="line none">   88     <a href="kani_lib.c.html#8">free</a>(ptr);</div><div id="89" class="line none">   89     return VoidUnit;</div><div id="90" class="line none">   90 }</div><div id="91" class="line none">   91 </div><div id="92" class="line none">   92 // This is a C implementation of the __rust_realloc function that has the following signature:</div><div id="93" class="line none">   93 //     fn __rust_realloc(ptr: *mut u8, old_size: usize, align: usize, new_size: usize) -&gt; *mut u8;</div><div id="94" class="line none">   94 // This low-level function is called by std::alloc:realloc, and its</div><div id="95" class="line none">   95 // implementation is provided by the compiler backend, so we need to provide an</div><div id="96" class="line none">   96 // implementation for it to prevent verification failure due to missing function</div><div id="97" class="line none">   97 // definition.</div><div id="98" class="line none">   98 // For safety, refer to the documentation of GlobalAlloc::realloc:</div><div id="99" class="line none">   99 // https://doc.rust-lang.org/std/alloc/trait.GlobalAlloc.html#method.realloc</div><div id="100" class="line none">  100 uint8_t *<a href="kani_lib.c.html#100">__rust_realloc</a>(uint8_t *ptr, size_t old_size, size_t align, size_t new_size)</div><div id="101" class="line none">  101 {</div><div id="102" class="line none">  102     // Passing a NULL pointer is undefined behavior</div><div id="103" class="line none">  103     <a href="kani_lib.c.html#22">__KANI_assert</a>(ptr != 0, "rust_realloc must be called with a non-null pointer");</div><div id="104" class="line none">  104 </div><div id="105" class="line none">  105     // Passing a new_size of 0 is undefined behavior</div><div id="106" class="line none">  106     <a href="kani_lib.c.html#22">__KANI_assert</a>(new_size &gt; 0, "rust_realloc must be called with a size greater than 0");</div><div id="107" class="line none">  107 </div><div id="108" class="line none">  108     // TODO: Ensure we are doing the right thing with align</div><div id="109" class="line none">  109     // https://github.com/model-checking/kani/issues/1168</div><div id="110" class="line none">  110     <a href="kani_lib.c.html#22">__KANI_assert</a>(<a href="kani_lib.c.html#30">__KANI_is_nonzero_power_of_two</a>(align), "Alignment is power of two");</div><div id="111" class="line none">  111 </div><div id="112" class="line none">  112     uint8_t *result = malloc(new_size);</div><div id="113" class="line none">  113     if (result) {</div><div id="114" class="line none">  114         size_t bytes_to_copy = new_size &lt; old_size ? new_size : old_size;</div><div id="115" class="line none">  115         <a href="kani_lib.c.html#9">memcpy</a>(result, ptr, bytes_to_copy);</div><div id="116" class="line none">  116         <a href="kani_lib.c.html#8">free</a>(ptr);</div><div id="117" class="line none">  117     }</div><div id="118" class="line none">  118 </div><div id="119" class="line none">  119     return result;</div><div id="120" class="line none">  120 }</div>
</div>
</body>
</html>
